<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="topWrapper">
    </div>
    
    <div id="bottomWrapper">
      <label id="pointer">>></label>
      <textarea id="codeInput" onkeyup="render()" spellcheck="false"></textarea>
    </div>

    
    <script>
      var hist = 0;
      document.getElementById("codeInput").onkeydown = function(e){
	  if(e.keyCode==9 || e.which==9){ // tab
              e.preventDefault();
              var s = this.selectionStart;
              this.value = this.value.substring(0,this.selectionStart) + "\t" + this.value.substring(this.selectionEnd);
              this.selectionEnd = s+1; 
          }
	  if(e.keyCode==38 || e.which==38){ // up
	      var start = this.selectionStart;
	      var finish = this.selectionEnd;
	      topWrapper = document.getElementById("topWrapper")
	      if(start == finish && (this.value.indexOf("\n") == -1 || this.value.indexOf("\n") >= start) && topWrapper.children.length > hist){
		  e.preventDefault();
		  this.value = topWrapper.children[topWrapper.children.length-(hist++)-1].children[0].children[1].innerText;
		  this.setSelectionRange(this.value.length,this.value.length);
	      }
          }
	  if(e.keyCode==40 || e.which==40){ // down
	      var start = this.selectionStart;
	      var finish = this.selectionEnd;
	      topWrapper = document.getElementById("topWrapper")
	      if(start == finish && (this.value.lastIndexOf("\n") == -1 || this.value.lastIndexOf("\n") < start)){
		  e.preventDefault();
		  --hist;
		  if(hist<0)
		      hist = 0;
		  if(hist == 0)
		      this.value = "";
		  else
		      this.value = topWrapper.children[topWrapper.children.length-hist].children[0].children[1].innerText;
	      }
          }
	  if((e.keyCode==13 || e.which==13) && !e.shiftKey){ // enter
              e.preventDefault();
	      var code = document.getElementById("codeInput").value;

	      if(code == "")
		  return;
	      
	      hist = 0;

	      // also, redirect console.log to our terminal emulator
	      // this means we need to start building divs first


	      document.getElementById("codeInput").value = "";
	      var resultWrapper = document.createElement('div');
	      resultWrapper.className = "resultWrapper";

	      var evaluatedWrapper = document.createElement('div');
	      evaluatedWrapper.className = "tableWrapper";
	      var resultPointer = document.createElement('label');
	      resultPointer.className = "resultPointer";
	      resultPointer.innerText = ">>";
	      var evaluated = document.createElement('span');
	      evaluated.className = "evaluated";
	      evaluated.innerText = code;
	      evaluatedWrapper.appendChild(resultPointer);
	      evaluatedWrapper.appendChild(evaluated);
	      resultWrapper.appendChild(evaluatedWrapper);

	      
	      oldLog = console.log;
	      console.log = function(wrapper){
		  return function(result){
		      var logWrapper = document.createElement('div');
		      logWrapper.className = "tableWrapper";
		      var resultArrow = document.createElement('label');
		      resultArrow.className = "resultArrow";
		      resultArrow.innerText = " ";
		      var returned = document.createElement('span');
		      returned.className = "returned";
		      if(typeof result == "number" && !isNaN(result))
			  returned.style.color = "#68A45D";
		      if(typeof result == "string")
			  returned.style.color = "#D7D7DB";
		      if(typeof result == "boolean")
			  returned.style.color = "#78C46A";
		      if(typeof result == "function" || typeof result == "object")
			  returned.style.color = "#75BFFF";
		      if(error)
			  returned.style.color = "red";
		      returned.innerText = result;
		      
		      logWrapper.appendChild(resultArrow);
		      logWrapper.appendChild(returned);
		      resultWrapper.appendChild(logWrapper);
		  }
	      }(resultWrapper);
	      var result;
	      error = false;
	      try{
		  result = (1, eval)(code);
	      } catch(e) {
		  result = e;
		  error = true; // so errors work
	      }
	      console.log = oldLog;

	      
	      
	      
	      var logWrapper = document.createElement('div');
	      logWrapper.className = "tableWrapper";
	      var resultArrow = document.createElement('label');
	      resultArrow.className = "resultArrow";
	      resultArrow.innerText = error ? " " : "←";
	      var returned = document.createElement('span');
	      returned.className = "returned";
	      if(typeof result == "number" && !isNaN(result))
		  returned.style.color = "#68A45D";
	      if(typeof result == "boolean")
		  returned.style.color = "#78C46A";
	      if(typeof result == "string")
		  returned.style.color = "#D7D7DB", result = "\"" + result + "\"";
	      if(typeof result == "function" || typeof result == "object")
		  returned.style.color = "#75BFFF";
	      if(error)
		  returned.style.color = "red";
	      returned.innerText = result;
	      logWrapper.appendChild(resultArrow);
	      logWrapper.appendChild(returned);
	      resultWrapper.appendChild(logWrapper);

	      
	      topWrapper.appendChild(resultWrapper);
	      render();
	      document.getElementById("topWrapper").scrollTop = document.getElementById("topWrapper").scrollHeight;
          }
      }

      var prevScrollHeight;
      render = function(){
	  codeInput = document.getElementById("codeInput");
	  bottomWrapper = document.getElementById("bottomWrapper");
	  topWrapper = document.getElementById("topWrapper");
	  
	  bottomWrapper.style.height = (document.body.offsetHeight - topWrapper.offsetHeight) + "px";
	  codeInput.style.overflowY = "hidden";
	  if(topWrapper.scrollHeight+codeInput.scrollHeight > document.body.offsetHeight && codeInput.scrollHeight != prevScrollHeight){
	      bottomWrapper.style.height = "14pt";
	      bottomWrapper.style.height = (codeInput.scrollHeight)+'px';
	      topWrapper.style.height = window.innerHeight-bottomWrapper.offsetHeight + "px";
	      if(topWrapper.offsetHeight < 19){ // need to start scrolling on input
		  topWrapper.style.height = "14pt";
		  bottomWrapper.style.height = (document.body.offsetHeight - topWrapper.offsetHeight) + "px";
		  codeInput.style.overflowY = "scroll";
		  codeInput.blur();
		  codeInput.focus();
	      }
	  }
	  prevScrollHeight = codeInput.scrollHeight;
      }

      window.onresize = render;
      render();
    </script>
  </body>
</html>
